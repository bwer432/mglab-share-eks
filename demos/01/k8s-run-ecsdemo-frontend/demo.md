## k8s-run-ecsdemo-frontend

#### GIVEN:
  - A developer desktop with docker & git installed (AWS Cloud9)
  - A container image for a web app workload (ECS demo frontend) in Amazon ECR
  - A Kubernetes cluster (e.g. Amazon EKS)

#### WHEN:
  - I run the container image in Kubernetes

#### THEN:
  - I will get a Pod running that container on a Kubernetes worker node

#### SO THAT:
  - I can inspect the runtime environment of the pod
  - I can inspect the runtime environment inside the container in the pod

#### [Return to Main Readme](https://github.com/bwer432/mglab-share-eks#demos)

---------------------------------------------------------------
---------------------------------------------------------------
### REQUIRES

- 00-setup-cloud9
- Either:
  - 03/create-cluster-eksctl-existing-vpc-advanced
  - 03/create-cluster-terraform
  - or similar

---------------------------------------------------------------
---------------------------------------------------------------
### DEMO

#### 0: Reset Cloud9 Instance environ from previous demo(s).
- Reset your region & AWS account variables in case you launched a new terminal session:
```
cd ~/environment/mglab-share-eks/demos/01/docker-build-wordpress/
export C9_REGION=$(curl --silent http://169.254.169.254/latest/dynamic/instance-identity/document |  grep region | awk -F '"' '{print$4}')
export C9_AWS_ACCT=$(curl -s http://169.254.169.254/latest/dynamic/instance-identity/document | grep accountId | awk -F '"' '{print$4}')
clear
echo $C9_REGION
echo $C9_AWS_ACCT
```

#### 1: Query the Amazon Elastic Contaner Registry (Amazon ECR) for a container image.
- Look for an image called ecsdemo/frontend
```
region=us-east-2
repo=$(aws ecr describe-repositories --region $region --repository-names ecsdemo/frontend --query repositories[].repositoryUri --output text)
echo $repo
```

#### 2. Run this container image as a container in a pod in Kubernetes.
- Use `kubectl` to run a new pod with one container running that container image.
- e.g. `kubectl run frontend --image 042617493216.dkr.ecr.us-east-2.amazonaws.com/ecsdemo/frontend`
- ...but we'll use the $repo variable with the URI of the image in ECR
```
kubectl run frontend --image $repo
```

#### 3. Check that the container is running and what data has been logged.
- Get a list of pods running in the default Kubernetes namespace.
- Look at the logs generated by that pod.
```
kubectl get pods
kubectl logs frontend | tail
```

#### 4. Check what is running inside that container in your pod.
- List the processes running in the container.
- Inspect the network configuration inside the container in the pod.
```
kubectl exec frontend -- ps -ef
kubectl exec frontend -it -- bash
uname -a
hostname
ip address
ss -at
```

#### 5. Connect to the web app running in this container.
- Get the contents of the web app running in this container.
- Check the DNS resolver configuration inside the container.
- Get out of the container.
```
curl -s localhost:3000 | grep Hello   
cat /etc/resolv.conf
exit
```

#### 6. Connect from the outside.
- Provide a mapping using the `kubectl` port forwarding command.
- Run this command in a **LOCAL** Terminal/shell, *not* in Cloud9.
```
kubectl port-forward pod/frontend :3000
```
- You should receive a message such as:
  - Forwarding from 127.0.0.1:64308 -> 3000
  - Forwarding from [::1]:64308 -> 3000
- Connect to that site using your web browser.
- Use a URL such as http://localhost:64308 but with the port identified by port-forward.
- Close the browser tab and cancel (Ctrl+C) the port-forward when done.

#### 7. Compare the IP address of the Pod with the IP address of its host node.
- Use the `wide` output option to list pods with IP addresses and more.
- Get a list of Kubernetes worker nodes.
```
kubectl get pod -o wide
kubectl get nodes
```

---------------------------------------------------------------
---------------------------------------------------------------
### DEPENDENTS
- None

---------------------------------------------------------------
---------------------------------------------------------------
### CLEANUP
- Do not cleanup if you plan to run any dependent demos
```
export C9_REGION=$(curl --silent http://169.254.169.254/latest/dynamic/instance-identity/document |  grep region | awk -F '"' '{print$4}')
aws ecr delete-repository --region $C9_REGION --repository-name eks-demo-wordpress --force
```
